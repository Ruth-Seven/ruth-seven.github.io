---
title: CSAPP笔记3-程序的机器级表示
thumbnail: 'http://static.come2rss.xyz/尼尔机械.jpg'
toc: true
top: 10
categories:
date: 2020-08-12 13:18:54
tags:
---

主要记录C代码对应机器指令是什么，具体实现过程。

<!-- more -->

## 过程

过程是一种软件封装思想，输入参数并指定返回值以实现一种功能。过程的形式有函数、方法、子例程和处理函数。

过程的一个通性就是使用了先进先出的内容管理原则。

### 运行时栈

运行函数会在调用函数是，将多余六个参数的参数加入到栈中，并保存返回地址。剩下的交给被调用函数，被调用函数将保护现场——保存寄存器，将寄存器放不下的临时变量加入栈中，“Argument build area”不太清除。被调用的函数在栈中所构建的内容称为栈帧。注意不是每个函数都需要栈帧，注意栈顶指针是%rsp。

![image-20200812140015179](http://static.come2rss.xyz/image-20200812140015179.png)



## C数据结构

### struct

struct的所有成员都存放在一段连续区域中，指向结构的指针的内容是结构的最低地址。编译器维护结构信息，指示每个字段的字节偏移，并把这些偏移编码到内存引用指令中，从而产生对结构元素的引用。

### union

union联合可以保存两个互斥（不可同时存在）的数据类型，其大小与最大的成员相同。union还可以通过引用不同的成员来存储数据，甚至改变不同字节上的数据，当然字节顺序就成了问题。

```c
double uu2double(unsigned word0, unsigned word1){
    union{
        double d;
     	unsigned u[2];
    }temp;
    
    temp.u[0] = word0;
    temp.u[1] = word1;
    return temp.d; //两个unsinged组成一个double类型元素，小端机器上temp.u[0]是d的低位四个字节。
}
```

### 数据对齐

为了提升数据存取效率，设立了数据对齐的原则——任何$K$字节的基本对象的地址必须是$K$的倍数。如下：

| K    | 类型                      |
| ---- | ------------------------- |
| 1    | char                      |
| 2    | short                     |
| 4    | int，float                |
| 8    | long，double，**`char*`** |

深入的考虑，S2的三个元素的分配的内存空间如下：`int:0；int:4；char；8`。重点是，如果考虑了S2[2]元素的存在条件，为了保证每个元素的成员地址在正确的位置，应该再分配S2成员3个比特。如此整个结构的空间为12bytes。

```c
struct S2{
    int i;
    int j;
    char c;
};
```

### 指针

指针是C的特色，也是极容易错误的内容。

+ 将指针从一种类型强制转化为另一种类型，只改变他的类型，而不改变他的值
+ 指针也可以指向函数。

```c
int fun(int x, int *P);
//定义了一个指向以int和int *为参数，返回int的函数指针。
int (*fp)(int, int *);//int *fp(int, int *)会被解释为函数原型
fp = fun;
```









