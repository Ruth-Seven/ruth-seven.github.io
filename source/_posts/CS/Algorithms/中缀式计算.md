---
title: 中缀式计算
thumbnail: 'http://static.come2rss.xyz/尼尔机械.jpg'
toc: true
top: 10
categories:
date: 2020-08-07 12:09:56
tags:
---



中缀表示式计算分为两个步骤，一是中缀转后缀，二是后缀表达式计算；

```c++
#include<string>
#include<cstdio>
#include<iostream>
#include<queue>
#include<stack>
#include<map>
using namespace std;

stack<char> stop; // 符号栈
map<char, int> opp; // 运算符 映射到优先级 the priority of operators
stack<double> stn;// 数字栈

string mid2Post(string s){
	string res;
	for(int i = 0; i < s.size(); i++){
		if(isdigit(s[i]) || s[i] == '.') res += s[i];
		else{
            if(s[i] == ' ') continue; //去空格
			if(s[i] == '(') stop.push(s[i]);
			else if(s[i] == ')'){
				while(stop.top() != '('){
					res += stop.top();
					stop.pop();
				}

				stop.pop();
			}else{
				int pro = opp[s[i]];
				//为运算符两旁数字插入空格,否则无法区分数字
				res += ' ';
				//pop出运算优先级高的运算操作符
				while( !stop.empty() && pro <= opp[stop.top()]){ //注意这里stack要有数据,
					res += stop.top();
					stop.pop();
				}
				stop.push(s[i]);
			}
		}
	}
    
	while(!stop.empty()){
		res += stop.top();
		stop.pop();
	}
	return res;
}

// 获取正数（可有小数点）
double getNum(string &str, int &pos){
	int k = pos, flag = 1;// flag = 1表计算正整数
	double inter = 0, fac = 0, pow10 = 10;
	while(isdigit(str[k]) || str[k] == '.'){
	 	if( str[k] == '.') flag = 0;  
		else if(flag == 1){	//计算正整数
			inter = inter * 10 + (double)(str[k] - '0'); //地址？
		}else{	// 计算小数
			fac += (double)(str[k]-'0') / pow10;
			pow10 *= 10;
		}
		k++;
	 	if(k >= str.size() ) break;
	}
	pos = k;
	return inter + fac;
}


//计算后缀表达式的值
double calPost(string pStr){
	if(pStr.size() == 0) return 0;
	for(int i = 0; i < pStr.size(); i++){
		if(isdigit(pStr[i])){ //对于数字
			double t = getNum(pStr, i);
			i--; //多加了一次i
			printf("%f\n", t);
			stn.push(t);			
		}else if(pStr[i] == '+' || pStr[i] == '-' ||
			pStr[i] == '*' || pStr[i] == '/') { // 对于运算符（不包括小数，理论上规范的格式中应该被数据包裹着）
			double op2 = stn.top(); stn.pop(); //注意压栈后 数据顺序是反的
             double op1 = stn.top(); stn.pop();
    		if(pStr[i] == '+') stn.push(op1 + op2);
    		else if(pStr[i] == '-') stn.push(op1 - op2);
    		else if(pStr[i] == '*') stn.push(op1 * op2);
    		else if(pStr[i] == '/') stn.push(op1 / op2); //不做非零判断了

		}
	}
	if( stn.size() != 1){
		printf("error! the size of stck of num isn't 1.\n");
		return -1;
	} 
	return stn.top();
}
int main(){
    //freopen("data.in", "r", stdin);
	string str;
	getline(cin, str);
    cout << str << endl;
	opp['+'] = opp['-'] = 1;
    opp['/'] = opp['*'] = 2;
	opp['('] = 0; //'(' 特殊处理
    string pStr = mid2Post(str);
    cout << pStr << endl;
    double calRes = calPost(pStr);
    printf("%.2lf\n", calRes);
}
```

细节上也可以再改动，比如在识别数字的时候就把它提取出来并用结构体的形式存储下来。